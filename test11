var WidgetMetadata = {
    id: "javdb_search_enhanced",
    title: "JavDB",
    description: "获取 JavDB 搜索",
    author: "",
    site: "https://javdb.com",
    version: "1.0.0",
    requiredVersion: "0.0.1",
    modules: [
        {
            title: "JavDB 搜索",
            description: "输入关键词•番号搜索影片",
            requiresWebView: false,
            functionName: "searchJavDB",
            sectionMode: false,
            cacheDuration: 300,
            params: [
                {
                    name: "code",
                    title: "关键词•番号",
                    type: "input",
                    description: "输入番号或者关键词(如:DLDSS-408或者楪カレン)",
                    value: "",
                    placeholders: [
                        { title: "示例番号", value: "DLDSS-408" },
                        { title: "示例关键词", value: "楪カレン" }
                    ]
                }
            ]
        }
    ]
};

async function searchJavDB(params, env) {
    const keyword = encodeURIComponent(params.code || "");
    const url = `https://javdb.com/search?q=${keyword}&f=all`;

    const html = await env.$http.get(url, {
        headers: {
            "User-Agent": env?.$defaultUserAgent,
            "Referer": "https://javdb.com/"
        }
    });

    const $ = env.$load(html);
    const results = [];

    $("div.video-item").each((i, el) => {
        const title = $(el).find(".video-title").text().trim();
        const cover = $(el).find("img").attr("data-src") || $(el).find("img").attr("src");
        const link = "https://javdb.com" + ($(el).find("a").attr("href") || "");
        const info = $(el).find(".video-meta").text().trim();
        const date = $(el).find(".meta-item:contains('发行时间')").text().replace("发行时间: ", "");

        results.push({
            title: title,
            description: info,
            image: cover,
            url: link,
            route: link,
            buttons: [
                {
                    title: "打开详情页",
                    action: "webview",
                    url: link
                }
            ]
        });
    });

    if (results.length === 0) {
        return [{
            title: "未找到任何结果",
            description: `关键词「${params.code}」无匹配结果，请更换关键词或稍后再试。`
        }];
    }

    return results;
}